services:
  # ==========================================================================
  # JobManager - Control Plane
  # ==========================================================================
  jobmanager:
    build:
      context: .
      target: jobmanager
    container_name: bicycle-jobmanager
    hostname: jobmanager
    ports:
      - "9000:9000"   # Control plane RPC
    environment:
      - RUST_LOG=info,bicycle=debug
      - BICYCLE_STATE_DIR=/var/bicycle/state
      - BICYCLE_CHECKPOINT_DIR=/var/bicycle/checkpoints
    volumes:
      - jobmanager-state:/var/bicycle/state
      - checkpoints:/var/bicycle/checkpoints
    networks:
      - bicycle-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9000"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Workers - Data Plane
  # ==========================================================================
  worker-1:
    build:
      context: .
      target: worker
    container_name: bicycle-worker-1
    hostname: worker-1
    ports:
      - "9001:9001"   # Control plane
      - "9101:9101"   # Data plane
      - "9999:9999"   # Socket job input (if job lands on worker-1)
      - "9998:9998"   # Socket job output (if job lands on worker-1)
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/worker", "--jobmanager", "jobmanager:9000", "--bind", "0.0.0.0:9001", "--data-bind", "0.0.0.0:9101", "--slots", "4", "--memory-mb", "2048"]
    volumes:
      - worker1-state:/var/bicycle/state
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

  worker-2:
    build:
      context: .
      target: worker
    container_name: bicycle-worker-2
    hostname: worker-2
    ports:
      - "9002:9001"   # Control plane
      - "9102:9101"   # Data plane
      - "19999:9999"  # Socket job input (if job lands on worker-2)
      - "19998:9998"  # Socket job output (if job lands on worker-2)
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/worker", "--jobmanager", "jobmanager:9000", "--bind", "0.0.0.0:9001", "--data-bind", "0.0.0.0:9101", "--slots", "4", "--memory-mb", "2048"]
    volumes:
      - worker2-state:/var/bicycle/state
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

  # ==========================================================================
  # CLI (interactive command-line interface)
  # ==========================================================================
  cli:
    build:
      context: .
      target: cli
    container_name: bicycle-cli
    environment:
      - RUST_LOG=warn
      - BICYCLE_JOBMANAGER=jobmanager:9000
    volumes:
      - ./jobs:/opt/bicycle/jobs:ro
    networks:
      - bicycle-net
    depends_on:
      jobmanager:
        condition: service_healthy
    profiles:
      - cli
    # Usage: docker compose --profile cli run cli <command>
    # Examples:
    #   docker compose --profile cli run cli status
    #   docker compose --profile cli run cli jobs
    #   docker compose --profile cli run cli run jobs/wordcount.yaml
    #   docker compose --profile cli run cli list

  # ==========================================================================
  # Socket Test (for testing socket connectors)
  # ==========================================================================
  socket-test:
    build:
      context: .
      target: socket-test
    container_name: bicycle-socket-test
    ports:
      - "9998:9998"
      - "9999:9999"
    environment:
      - RUST_LOG=info
    networks:
      - bicycle-net
    profiles:
      - test
    # Usage: docker-compose --profile test run socket-test echo
    command: ["echo", "--source-port", "9999", "--sink-port", "9998"]

  # ==========================================================================
  # Standalone Jobs (custom Rust streaming jobs)
  # ==========================================================================
  wordcount:
    image: bicycle-wordcount
    container_name: bicycle-wordcount
    hostname: wordcount
    ports:
      - "7999:9999"   # Job input port
      - "7998:9998"   # Job output port
    environment:
      - RUST_LOG=info
    command: ["--source-port", "9999", "--sink-port", "9998"]
    networks:
      - bicycle-net
    profiles:
      - jobs
    # Usage: docker compose --profile jobs up wordcount
    # Then:  nc localhost 7999 (send input)
    #        nc localhost 7998 (receive output)

  # ==========================================================================
  # Web UI
  # ==========================================================================
  webui:
    build:
      context: .
      target: webui
    container_name: bicycle-webui
    hostname: webui
    ports:
      - "8081:8081"   # Web UI HTTP
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/webui", "--bind", "0.0.0.0:8081", "--jobmanager", "jobmanager:9000"]
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

# ==========================================================================
# Networks
# ==========================================================================
networks:
  bicycle-net:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  jobmanager-state:
  worker1-state:
  worker2-state:
  checkpoints:
